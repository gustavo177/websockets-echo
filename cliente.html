<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráficas con chart.js | By Parzibyte</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/Chart.min.js"></script>
  </head>
  <body>
    <h1>WebSocket Client</h1>
    <button id="pauseButton">Pausar</button>
    <canvas id="grafica"></canvas>

    <div>

      <input type="text" id="messageInput" placeholder="Message" />
      <button onclick="sendMessage()">Send</button>




    </div>
    
    <div id="messages"></div>
    
    <script>
      // de forma local
      // const socket = new WebSocket("ws://localhost:8000/");
      
      // Conectando al servidor que se alojo en produccion en render
      const socket = new WebSocket("wss://websockets-echo-o4pd.onrender.com/");

      // Creamos un array vacío para los datos del 1 sensor 
      let data1 = [];
      // Creamos un array vacío para los datos del 2 sensor 
      let data2 = [];
      // Creamos un array vacío para los datos del 3 sensor 
      let data3 = [];
      // Creamos un array vacío para los datos del 4 sensor 
      let data4 = [];
      // Creamos un array vacío para los datos del 5 sensor 
      let data5 = [];
      // Creamos un array vacío para los datos del 6 sensor 
      let data6 = [];
      // Creamos un array vacío para los datos del 7 sensor 
      let data7 = [];
      // Creamos un array vacío para los datos del 8 sensor 
      let data8 = [];
      
      socket.onmessage = function (event) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.innerText = event.data;
        messagesDiv.appendChild(messageDiv);

        // console.log('Mensaje recibido:', event.data); // muestra el mensaje recibido en la consola del navegador
        // console.log('tipo de dato:', typeof(event.data)); // muestra el tipo de dato en consola que llega del servidor

        // Guardamos el dato obtenido del servidor en una variable local
        let guardar = event.data;
        // Obtenemos un array de tipo string
        let array = guardar.split(",");

        // Convertimos los datos de tipo string a number 
        let sensor_0 = +array[0]
        let sensor_1 = +array[1]
        let sensor_2 = +array[2]
        let sensor_3 = +array[3]
        let sensor_4 = +array[4]
        let sensor_5 = +array[5]
        let sensor_6 = +array[6]
        let sensor_7 = +array[7]


        // console.log('Lista:', array); // muestra la lista
        // console.log('tipo de dato:', typeof(+array[0])); // convertimos los datos en la posicion 0 a number


        // Obtener una referencia al elemento canvas del DOM
        const $grafica = document.querySelector("#grafica");
        // Las etiquetas son las que van en el eje X. 


        // const etiquetas = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]


        const etiquetas = [1, 2, 3, 4, 5, 6]
        //const etiquetas = []


        // Creamos la gráfica


        let chart = new Chart($grafica, {
          type: 'line',
          data: {
            labels: etiquetas,
            datasets: [
              {
                label: 'Línea 1',
                borderColor: 'rgb(255, 99, 132)',
                data: data1
              },
              {
                label: 'Línea 2',
                borderColor: 'rgb(54, 162, 235)',
                data: data2
              },
              {
                label: 'Línea 3',
                borderColor: 'rgb(255, 161, 50)',
                data: data3
              },
              {
                label: 'Línea 4',
                borderColor: 'rgb(151, 161, 50)',
                data: data4
              },
              {
                label: 'Línea 5',
                borderColor: 'rgb(151, 161, 134)',
                data: data5
              },
              {
                label: 'Línea 6',
                borderColor: 'rgb(0, 255, 67)',
                data: data6
              },
              {
                label: 'Línea 7',
                borderColor: 'rgb(0, 68, 255)',
                data: data7
              },
              {
                label: 'Línea 8',
                borderColor: 'rgb(54, 162, 235)',
                data: data8
              }
            ]
          },
          options: {
            animation: false
          }
        });

        let incremento=0

        // numero aleatorio con decimales

        function aleatorio(minimo, maximo, decimales) {
          var precision = Math.pow(10, decimales);
          minimo = minimo*precision;
          maximo = maximo*precision;
          return Math.floor(Math.random()*(maximo-minimo+1) + minimo) / precision;
        }

        
        
        // Función para actualizar los datos de la gráfica
        function updateChart() {
          // incremento=incremento+1
          // chart.data['labels'] = (etiquetas.push(incremento))
          // console.log(incremento)

          // detener animation de cada sensor
          // document.getElementById('pauseButton').addEventListener('click', function() {
          //   chart.options.animation.duration = 0;
          // });

          // // Reanudar la grafica
          // document.getElementById('pauseButton').addEventListener('click', function() {
          //   chart.options.animation.duration = 1000;
          // });


          // Obtenemos los datos del servidor (en este caso, generamos datos aleatorios)
          
          // let newData1 = Math.floor(Math.random() * 10) + 3;
          // let newData2 = Math.floor(Math.random() * 10) + 1;
          
          // let newData1 = aleatorio(1,5,5)
          // let newData2 = aleatorio(1,3,5)

          let newData1 = sensor_0
          let newData2 = sensor_1
          let newData3 = sensor_2
          let newData4 = sensor_3
          let newData5 = sensor_4
          let newData6 = sensor_5
          let newData7 = sensor_6
          let newData8 = sensor_7



          
          // Añadimos los nuevos datos a los arrays
          data1.push(newData1);
          data2.push(newData2);
          data3.push(newData3);
          data4.push(newData4);
          data5.push(newData5);
          data6.push(newData6);
          data7.push(newData7);
          data8.push(newData8);
          
          let iterando=4
          // Si tenemos más de 10 datos, eliminamos el primer dato para mantener una ventana de 10 datos
          if (data1.length > iterando) {
            data1.shift();
          }
          
          if (data2.length > iterando) {
            data2.shift();
          }

          if (data3.length > iterando) {
            data3.shift();
          }

          if (data4.length > iterando) {
            data4.shift();
          }

          if (data5.length > iterando) {
            data5.shift();
          }
          
          if (data6.length > iterando) {
            data6.shift();
          }

          if (data7.length > iterando) {
            data7.shift();
          }

          if (data8.length > iterando) {
            data8.shift();
          }
          

          // etiquetas.push(incremento)
          // console.log(etiquetas)


          // Actualizamos la gráfica y anima el movimiento de la grafica
          chart.update();
          }

          // Actualizamos la gráfica cada 5 segundos
          setInterval(updateChart, 5000);
          };

      function sendMessage() {
        const message = document.getElementById("messageInput").value;
        socket.send(message);
      }

    </script>
  </body>
</html>